<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <link rel="stylesheet" href="./static/css/connectory_styles.css"></link>
    <script src="./static/js/d3-4.11.0.min.js"></script>
    <script src="./static/js/d3-scale-chromatic.min.js"></script>
    <script src="./static/js/d3-selection.min.js"></script>
    <script src="./static/js/d3-selection-multi.min.js"></script>
    <script src="./static/js/d3-transition.min.js"></script>
    <title>Rosetta Home</title>
  </head>
  <body>
    <div id="animate"></div>
    <canvas id="graph" width="1000px" height="800px"></canvas>
    <script>
      var hues = [
        d3.interpolateBuGn,
        d3.interpolateBuPu,
        d3.interpolateGnBu,
        d3.interpolateOrRd,
        d3.interpolatePuBuGn,
        d3.interpolatePuBu,
        d3.interpolatePuRd,
        d3.interpolateRdPu,
        d3.interpolateYlGnBu,
        d3.interpolateYlGn,
        d3.interpolateYlOrBr,
        d3.interpolateYlOrRd,
        d3.interpolateSpectral,
        d3.interpolateRdYlGn,
        d3.interpolateRdYlBu,
        d3.interpolateRdGy,
        d3.interpolateRdBu,
        d3.interpolatePuOr,
        d3.interpolatePiYG,
        d3.interpolatePRGn,
        d3.interpolateBrBG,
      ]
      var canvas = document.querySelector("canvas"),
        context = canvas.getContext("2d"),
        viz_height = 250,
        bg = canvas.getContext("2d");
      var w_w = window.innerWidth,
        w_h = window.innerHeight;
      canvas.width = w_w;
      canvas.height = w_h;
      var width = canvas.width,
        height = canvas.height
      var x = d3.scaleLinear()
        .range([0, width]);
      var v_top = (height - viz_height)/2;
      console.log(v_top);
      var y = d3.scaleLinear()
        .range([v_top, v_top+viz_height]);
      var x_range = 100,
        y_range = 25,
        data = random_data(),
        current_line = 0,
        total_lines = 400,
        last = 0,
        step = .02,
        paused = false,
        pause_duration = 3000,
        point_dir = {x: 1, y: -1},
        line_dash = [1,3],
        color_pallette = hues[Math.floor(Math.random()*hues.length)];

      bg.fillStyle = color_pallette(1);
      bg.fillRect(0, 0, width, height);

      var svg = d3.select("#animate")
        .append("svg")
        .attrs({
          width: width,
          height: height,
          id: "visualization",
          xmlns: "http://www.w3.org/2000/svg"
        });

      x.domain([0, x_range]);
      y.domain([0, y_range]);

      var line = d3.line()
        .x(function(d) { return x(d.x); })
        .y(function(d) { return y(d.y); })
        .curve(d3.curveBundle)
        .context(context);

      function render(){
        var d_p = [];
        for(var d = 0; d < data.length; d++){
          d_p[d] = {x: data[d].x + ((current_line*step)*point_dir.x), y: data[d].y + ((current_line*step)*point_dir.y)};
        }
        context.beginPath();
        line(d_p);
        context.lineWidth = 1;
        var color = color_pallette((current_line/total_lines));
        context.strokeStyle = color;
        context.shadowBlur = 0;
        context.shadowColor = color;
        context.setLineDash(line_dash)
        context.stroke();
        context.closePath();
      }

      function random_data(){
        var dat = [];
        for(var i = 0; i < x_range; i++){
          dat[i] = {x: i, y: Math.random()*y_range}
        }
        return dat;
      }

      function animate(ts){
        render();
        if(current_line < (total_lines-1)){
          current_line++;
        }else{
          paused = true;
        }
        if(paused){
          setTimeout(function(){
            current_line = 0;
            data = random_data();
            point_dir = {x: Math.random() >= .5 ? 1 : -1, y: Math.random() >= .5 ? 1 : -1};
            line_dash = [Math.ceil(Math.random()*3), Math.ceil(Math.random()*5)]
            paused = false;
            context.clearRect(0, 0, width, height);
            bg.clearRect(0, 0, width, height);
            color_pallette = hues[Math.floor(Math.random()*hues.length)];
            bg.fillStyle = color_pallette(1);
            bg.fillRect(0, 0, width, height);
            animate_line();
          }, pause_duration);
        }else{
          requestAnimationFrame(animate);
        }
      }

      function animate_line(){
        var color = document.getElementById("animate");
        color.style.backgroundColor = color_pallette(1);
        color.style.display = "block";
        var l = d3.line()
          .x(function(d) { return x(d.x); })
          .y(function(d) { return y(d.y); })
          .curve(d3.curveBundle)
        svg.selectAll("*").remove();
        var path = svg.append("path")
          .attr("d", l(data))
          .attr("stroke", color_pallette(0))
          .attr("stroke-width", "1")
          .attr("fill", "none");

        var tl = path.node().getTotalLength();
        path
          .attr("stroke-dasharray", tl + " " + tl)
          .attr("stroke-dashoffset", tl)
          .transition()
            .duration(5000)
            .attr("stroke-dashoffset", 0)

        setTimeout(function(){
          requestAnimationFrame(animate);
          var color = document.getElementById("animate");
          color.style.display = "none";
        }, 5000);
      }

      animate_line();
    </script>
  </body>
</html>
